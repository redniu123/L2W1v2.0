# C) 消融实验方案（Ablations，重写版）

> 目标：在严格预算与统一口径下逐项验证 SH‑DA++ 组件贡献，并提供可直接落地的开关映射表。[file:4]

## C1. 统一设置与公平性约束（必须遵守）

### 固定组件

- Agent A：PP‑OCRv5（权重、预处理、解码一致）。[file:4]
- Agent B：Qwen2.5‑VL‑3B（同一服务端、同一 decoding 参数：temperature/top_p/max_tokens 等）。[file:4]
- 回填规则：默认启用“严格回填 + 全局拒改”（除非该实验组明确禁用）。[file:4]

### 预算对齐

- 预算点：\(B\in\{10\%,20\%,30\%\}\)。[file:4]
- **在线控制组**：P‑control 更新 \(\lambda\)，要求 `Actual Call Rate = B ± 0.5%`。[file:4]
- **固定阈值组**：Validation Set 上搜索 \(\lambda\_{fix}\) 使 call rate 最接近 B，冻结后用于 Test（禁止 Test 调阈值）。[file:4]

### 数据闭环

- 校准/超参（\(\eta,k,W,\rho,K\) 等）只用 Validation Set。[file:4]
- Test Set 只出最终报表，不允许“再调一下”。[file:4]

### 统一日志与报表

每个实验点必须输出同结构 `metrics_summary.json`（或 CSV），至少包含：[file:4]

- overall CER
- Boundary Deletion Recall@B
- Substitution CER
- call rate（均值/方差）
- 稳定性三指标
- CVR/AER
- p95 latency
- token usage（如启用 RoI）

---

## C2. 指标计算协议（必须写死到 eval_metrics.py）

> 三类指标定义必须写死，防止“各人各算各的”。[file:4]

### (1) Boundary Deletion Recall@B

- 用 Levenshtein edit ops 对齐 \(T*A\) 与 \(T*{gt}\)。[file:4]
- 边界字符数 \(K*{bnd}=2\)（或 \(K*{bnd}=\lceil0.1|T\_{gt}|\rceil\)，二选一写死）。[file:4]
- 若存在 deletion 且 deletion 发生在 GT 索引区间 \([0,K_{bnd}-1]\cup[|T_{gt}|-K_{bnd},|T_{gt}|-1]\)，则样本计入 boundary‑deletion 集合。[file:4]
- Recall@B（路由召回）：集合中被 `upgrade=1` 的比例。[file:4]

### (2) Substitution CER

- 对齐后仅统计 substitution edit ops（可选：仅在非边界区间统计）。[file:4]

### (3) 可靠性

- CVR：触发“约束拒改/全局拒改”的比例。[file:4]
- AER：升级样本中“未拒改且 \(T\_{final}\neq T_A\)”的比例。[file:4]

---

## C3. 核心消融组（6 组，逐组控制变量）

### Abl‑1：w/o CTC Blank（验证 deletion 证据链）

- 保持不变：Layer2/3、EdgeProbe、Prompt/回填策略、AgentA/B。[file:4]
- 改变：从 \(s*b\) 移除 \(b*{edge}\) 与 \(v*{edge}\cdot b*{edge}\)，仅保留 \(drop\)（必须写死为“仅 drop”）。[file:4]
- 指标：Boundary Deletion Recall@B、overall CER。[file:4]
- 预期：Boundary Deletion Recall@B 显著下降。[file:4]
- 失败排查：若变化不明显，查 drop 是否过强主导；或 boundary deletion 占比过低。[file:4]

### Abl‑2：w/o Edge Probe（验证视觉‑序列冲突贡献）

- 保持不变：Layer2/3、\(b\_{edge}\)、Prompt/回填、AgentA/B。[file:4]
- 改变：从 \(s*b\) 移除 \(v*{edge}\) 与 \(v*{edge}\cdot b*{edge}\)，保留 \(b\_{edge}\) 与 \(drop\)。[file:4]
- 指标：Boundary Deletion Recall@B、PR‑AUC(\(s*b\to y*{deletion}\))。[file:4]
- 预期：PR‑AUC 与 boundary recall 下降；误报/漏报增加。[file:4]
- 失败排查：查 \(v*{edge}\) 归一化分位是否错误（导致 \(v*{edge}\approx0\)）；查 edge 切片坐标是否与 \(\rho\) 对齐。[file:4]

### Abl‑3：Rule-only vs Calibrated（验证校准收益）

- 保持不变：全量特征集（blank+edge+drop+margin）、Layer2/3、Prompt/回填、AgentA/B。[file:4]
- 改变：[file:4]
  - Rule-only：固定系数组合（默认等权）。[file:4]
  - Calibrated：val 上 LogReg 学习 \(s_b=\sigma(w^\top x)\)（是否校准 \(s_a\) 必须写清）。[file:4]
- 指标：overall CER、AUC/PR（\(s*b\to y*{deletion}\)，可选 \(s*a\to y*{subst}\)）。[file:4]
- 预期：同预算下 CER 进一步降低，AUC/PR 提升。[file:4]
- 失败排查：查 y_deletion 构造一致性；val 太小过拟合；\(\lambda_0\) 是否按各自 q 分位重新初始化。[file:4]

### Abl‑4：分诊与专科模板（验证策略与 prompt 专科化）

- 保持不变：Layer1 打分、Layer3 在线控制、AgentA/B、严格回填。[file:4]
- 改变（3 档）：[file:4]
  - Single Prompt：所有升级样本同一模板。[file:4]
  - Dual Prompt：BOUNDARY/AMBIGUITY 两模板。[file:4]
  - Four-path Prompt：NONE/BOUNDARY/AMBIGUITY/BOTH 四路径模板（BOTH 两阶段）。[file:4]
- 指标：Boundary CER（或 boundary deletion recall@B）、Substitution CER、CVR。[file:4]
- 预期：四路径最佳；NONE 降低无谓升级；BOTH 提升复合错行修复。[file:4]
- 失败排查：查 AgentB 是否遵循指令；查 BOTH 顺序与 idx 是否重算。[file:4]

### Abl‑5：Free-form vs Top‑2 Constrained（验证式纠错）

- 保持不变：Layer1/2/3、AgentA/B、严格回填。[file:4]
- 改变（仅 AMBIGUITY）：[file:4]
  - Free-form：允许自由生成修正字符/片段。[file:4]
  - Top‑2 constrained：只能在 \(\{c*{idx}^{(1)},c*{idx}^{(2)}\}\) 二选一输出单字符。[file:4]
- 指标：Substitution CER、CVR、AER。[file:4]
- 建议附加：Top‑2 coverage；拒改原因分解（top2_mismatch 占比）。[file:4]
- 预期：Top‑2 约束降低 CVR/幻觉风险，并改善 substitution。[file:4]
- 失败排查：若 CER 上升，常因 top‑2 coverage 过低（AgentA top‑2 不含真值）。[file:4]

### Abl‑6：Fixed Threshold vs Proportional Online Control（验证部署稳定性）

- 保持不变：Layer1/2（同一 q 定义）、AgentA/B、Prompt/回填。[file:4]
- 改变：[file:4]
  - Fixed threshold：val 搜索 \(\lambda\_{fix}\) 使 call rate≈B，test 冻结。[file:4]
  - Online control（P‑control）：\(\lambda\leftarrow\lambda+k(\widehat{B}-B)\)，并 clip 到 \([\lambda_{min},\lambda_{max}]\)。[file:4]
- 指标：稳定性三项 + overall CER。[file:4]
- 预期：Online control 窗口波动更小、burst 更少；fixed 在质量变化流中出现 spending bursts。[file:4]
- 失败排查：online 震荡 → 降 k 或增 W；fixed 太稳 → 做 stress test 再测。[file:4]

---

## C4. 控制稳定性指标（Stability Metrics）

1. Mean Call Rate Error：\(|\bar{B}-B|\)。[file:4]
2. Window-level 95% Error：95% 窗口 call rate 误差是否 ≤ 3%。[file:4]
3. Burstiness：call rate > \(B+10\%\) 的窗口比例。[file:4]

---

## C5. 实验开关映射表（Implementation Switches）

> 用于工程配置直接运行（可转 yaml）。[file:4]

| 实验 ID               | use_blank | use_edge | scorer_mode | prompt_mode | ambiguity_prompt | online_control | strict_backfill |
| --------------------- | --------: | -------: | ----------- | ----------- | ---------------- | -------------: | --------------: |
| Full (SH‑DA++)        |      True |     True | Calibrated  | Four-path   | Top2             |           True |            True |
| Abl‑1 (w/o Blank)     |     False |     True | Calibrated  | Four-path   | Top2             |           True |            True |
| Abl‑2 (w/o Edge)      |      True |    False | Calibrated  | Four-path   | Top2             |           True |            True |
| Abl‑3 (Rule-only)     |      True |     True | Rule-only   | Four-path   | Top2             |           True |            True |
| Abl‑4 (Single Prompt) |      True |     True | Calibrated  | Single      | Top2             |           True |            True |
| Abl‑5 (Free-form)     |      True |     True | Calibrated  | Four-path   | Free-form        |           True |            True |
| Abl‑6 (Fixed Thr)     |      True |     True | Calibrated  | Four-path   | Top2             |          False |            True |

注：若 Abl‑6 关闭 online*control，则必须启用 val 上 \(\lambda*{fix}\) 搜索流程并冻结到 test。[file:4]
