# B) SH‑DA++ Router 工程实施路线（补全执行版）

> 目标：按 Stage0–Stage3 把 Router 从“可复现信号导出”搭到“RoI 低成本前沿”，每步都有实现清单、必产物、硬验收阈值与失败排查。[file:1]

## B0. 全局工程约定（所有 Stage 通用）

### 硬约束（必须写进代码/CI）

- 任何标注 “@B=xx%” 的跑数：`Actual Call Rate = B ± 0.5%`，否则该 run 标记为 **invalid** 并自动重跑/报错。[file:1]
- 统一日志字段名、统一指标口径、统一版本快照（agentA_ckpt、router_commit、vocab_version、blank_id、rho 等）。[file:1]
- Prompt 与回填规则默认全局一致（除非实验显式改 prompt/backfill）。[file:1]

### 统一文件

- `router_features.jsonl`：每行一条，记录 Router 所有输入信号、特征、打分、阈值、分诊与升级决策。[file:1]
- `backfill_log.jsonl`：只对 upgrade 样本记录纠错与回填过程（含 usage token、拒改原因）。[file:1]
- `metrics_summary.json`：每次 run 固定输出（同 schema）。[file:1]

---

## Stage 0：数据接口与日志底座（预计 1 周）

**目标**：把 AgentA→Router 的“最小可复现信号”稳定导出，并完成抽样 debug 能力。[file:1]

### S0.1 必做开发任务（按优先级）

1. **CTC emission 接口（softmax）**[file:1]

- 导出 \(E\in[0,1]^{T\times C}\)，并明确 `blank_id`（配置读取，默认 0）。[file:1]
- 统一 `rho`（默认 0.1）并写入日志字段。[file:1]

2. **blank 边界统计在线计算（默认不落盘全量 E）**[file:1]

- 计算并落盘：`blank_mean_L, blank_mean_R, blank_peak_L, blank_peak_R`（L/R 由 rho 定义）。[file:1]
- 可选增强：`nonblank_ratio_L/R`（用于 debug 或后续特征扩展）。[file:1]

3. **top‑2 输出与质量标记**[file:1]

- 尝试导出 per-char top‑2 概率与候选字符：`top2_p1[i], top2_p2[i], top2_c1[i], top2_c2[i]`。[file:1]
- 无法稳定获取时：写 `top2_status ∈ {ok, missing, unstable}`，并记录 `top2_missing_rate`。[file:1]
- 降级策略只允许在 Stage1/2 Router 内做，不允许 Stage0 静默“补齐”。[file:1]

4. **latency 埋点拆分**[file:1]

- `lat_a_ms, lat_router_ms, lat_sentinel_ms, lat_b_ms, lat_total_ms`（先不接 B 时 `lat_b_ms=0`）。[file:1]

5. **抽样 debug 落盘**[file:1]

- 每 1000 行抽样保存一次 `E_blank[t]` 序列（不是全 \(E\)），用于绘制 blank 曲线/可视化定位。[file:1]
- 每 1000 行抽样保存一次 `edge_probe_debug.png`（原图 + I_L/I_R + 梯度热力）。[file:1]

### S0.2 交付物（必须存在）

- `router_features.jsonl` 最小字段集（建议固定 schema）：[file:1]
  - `id,img_path,agentA_ckpt,vocab_version,blank_id,rho,H_I,W_I,T,N,T_A,char_conf[]`[file:1]
  - `blank_mean_L,blank_mean_R,blank_peak_L,blank_peak_R`[file:1]
  - `top2_status,top2_missing_rate,(top2 arrays if ok)`[file:1]
  - `lat_a_ms,lat_router_ms,lat_total_ms`[file:1]

### S0.3 硬验收阈值

- 连续处理 10,000 行：无显存泄漏；`lat_router_ms` 相比未改造版本增量 < 5ms。[file:1]
- `blank_id`、`rho`、L/R 定义一致：同一行重复运行得到相同 blank 统计。[file:1]
- `top2_status` 可统计：missing/unstable 不是 0 且不是“永远 ok”（避免假实现）。[file:1]

### S0.4 常见失败与排查

- 文件爆炸：说明把全量 \(E\) 落盘了；改为只存统计量 + 抽样序列。[file:1]
- top‑2 全 missing：说明“对齐到字符位置”的实现没做或取错张量；先退化到 char_conf 做 \(s_a\)，但必须保留 top2_status。[file:1]

---

## Stage 1：Rule-only Router + 在线预算控制 + 异步闭环（预计 1–2 周）

**目标**：不训练，先把“风险打分 → 分诊 → 预算控制 → 升级 → 回填 → 日志”端到端跑通，并保证预算稳定。[file:1]

### S1.1 必做开发任务

1. **Layer1 计算（rule-only）**[file:1]

- 实现：\(b*{edge}\)、EdgeProbe 的 \(v*{edge}\)、\(drop\)、\(s*b\)、\(s_a\)、\(idx*{susp}\)、\(r_d\)（可先用 sentinel stub=0）、\(q\)。[file:1]
- EdgeProbe 归一化参数：val 集统计 `v_min/v_max`（1%/99% 分位），写入配置并版本化。[file:1]

2. **Layer2 分诊 + RoI（先不裁 RoI 也可以，但要产出坐标）**[file:1]

- `route_type`：NONE/BOUNDARY/AMBIGUITY/BOTH（BOTH 可暂时不调用两次 B，先把逻辑与日志跑通）。[file:1]
- RoI 坐标必须输出并可视化抽样（即使 Stage1 不启用真正裁剪）。[file:1]

3. **Layer3 在线预算控制（P-control）**[file:1]

- 参数固定：`W=200, k=0.05, lambda_min=0, lambda_max=2`。[file:1]
- 初始化：\(\lambda_0\) 来自 val 上 \(q\) 的 \(1-B\) 分位数（写入 config）。[file:1]
- warmup：前 W 行不计入稳定性统计（但仍运行控制器）。[file:1]

4. **异步队列 + 超时回退**[file:1]

- upgrade=True 样本入队调用 AgentB；OCR 主线程继续处理后续行。[file:1]
- 超时阈值：单行 B 推理 > 500ms 或队列满 → fallback \(T_A\)，记录 `b_timeout=true` 与原因。[file:1]

5. **基础回填（Stage1 简版）**[file:1]

- 可先做“整行替换”跑通，但必须输出“严格回填模式=off”，避免后续指标混淆。[file:1]
- 更推荐：Stage1 就接入严格回填框架（允许先只跑 AMBIGUITY 单点替换）。[file:1]

### S1.2 交付物（必须存在）

- `router_features.jsonl` 增补字段：[file:1]
  - `v_edge, drop, b_edge, s_b, s_a, idx_susp, r_d, eta, q, lambda, route_type, upgrade`[file:1]
- `metrics_summary.json`（固定 schema）：[file:1]
  - overall CER、boundary deletion recall@B（可先只算 upgrade recall）、call rate（均值/方差）、window error 分布、latency p50/p95（分模块）。[file:1]

### S1.3 硬验收阈值

- 预算达标：`Actual Call Rate = B ± 0.5%`（B=20%）。[file:1]
- 稳定性：窗口 W=200 统计，95% 窗口 call rate 在 `B ± 3%`。[file:1]
- pipeline 可用：队列拥塞不阻塞 OCR 主线程；b_timeout 有记录且 fallback 正确。[file:1]

### S1.4 常见失败与排查

- call rate 漂移/震荡：调小 k（0.01）或增大 W（500）；检查 \(\lambda_0\) 是否按分位初始化。[file:1]
- v_edge 全 0：归一化分位数统计错误或输入图像未按预期归一化。[file:1]
- idx_susp 越界：检查 N 与 char_conf/top2 长度一致性。[file:1]

---

## Stage 2：校准训练 + Top‑2 验证式纠错 + 严格回填/拒改（预计 2–4 周）

**目标**：提升 decision quality 与纠错可靠性，把大模型从自由生成压到受限验证者。[file:1]

### S2.1 必做开发任务

1. **标签自动构造（val set）**[file:1]

- `y_deletion`：对齐 \(T*A\) 与 \(T*{gt}\) 得到 edit ops；若 deletion 对应 GT 位置落在边界 K（固定 K=2 或 K=ceil(0.1\*len)，二选一写死）则 y_deletion=1。[file:1]
- 以 GT 索引判边界（写入文档与代码注释）。[file:1]

2. **Calibrated scorer（建议先只校准 s_b）**[file:1]

- 特征：`[v_edge, b_edge, v_edge*b_edge, drop]`。[file:1]
- 训练：LogReg（可选 GBDT），只用 val。[file:1]
- 验收：PR‑AUC/ROC‑AUC 提升（Δ>0.05 作为门槛）。[file:1]

3. **Top‑2 constrained prompt（AMBIGUITY 路径）**[file:1]

- Prompt 强制“二选一”：只允许输出 top‑2 中的一个字符。[file:1]
- 若 `top2_status!=ok`：记录并降级（free-form 或放弃修改），但必须统计降级比例。[file:1]

4. **严格回填 + 全局拒改**[file:1]

- BOUNDARY：只许首尾插入/替换。[file:1]
- AMBIGUITY：只许改单点 idx_susp 且必须在 top‑2 内，否则拒改。[file:1]
- Global rejection：ED>2 或长度变化>20% → fallback \(T_A\)。[file:1]

5. **安全红线（自动熔断）**[file:1]

- CVR>30%：自动熔断纠错路径（upgrade 可触发，但不应用修改/进入审计模式）。[file:1]
- AER>20%：作为“升级确实产生有效修改”的最低门槛。[file:1]

### S2.2 交付物（必须存在）

- `backfill_log.jsonl`：[file:1]
  - `id, route_type, idx_susp, T_A, T_B, T_final, ED, len_change_ratio`[file:1]
  - `is_rejected, CVR_reason (enum), AER_flag`[file:1]
  - `top2_status, top2_mismatch_flag`[file:1]
  - `prompt_id, usage_prompt_tokens, usage_completion_tokens, usage_total_tokens`[file:1]
- `audit_report.md`：Top‑K 拒改样本可视化。[file:1]

### S2.3 硬验收阈值

- PR‑AUC(y_deletion) 提升 Δ>0.05。[file:1]
- CVR ≤ 30%；AER ≥ 20%。[file:1]
- 预算仍达标：各 B 点 `B ± 0.5%`，窗口稳定性满足 Stage1。[file:1]

---

## Stage 3：RoI 路由 + 低延迟协议 + Efficiency Frontier（预计 1–2 周）

**目标**：把“升级成本”从整行降到局部 RoI，并画出性能—成本前沿。[file:1]

### S3.1 必做开发任务

1. **RoI 裁剪与 y 方向协议**[file:1]

- 默认：只裁 x 不裁 y（保留全高）避免截笔画；或上下各保留 5% padding（二选一写死）。[file:1]
- clamp：idx_susp=0 或 N-1 时不越界。[file:1]

2. **RoI resize 协议**[file:1]

- 裁剪后等比缩放到固定高度（如 48px），宽度等比后 padding 到模型要求。[file:1]
- 严禁非等比拉伸。[file:1]

3. **BOTH 在 RoI 下两阶段执行**[file:1]

- 顺序：BOUNDARY RoI→ 回填 → 重算 idx→AMBIGUITY RoI→ 回填，落日志 `both_stage=1/2`。[file:1]

4. **低延迟测试协议**[file:1]

- 写死：硬件型号、并发、batch size、是否 continuous batching、warmup 次数。[file:1]
- latency 统计来源统一为服务端埋点。[file:1]

5. **token 统计口径**[file:1]

- 使用 vLLM usage 字段（prompt/completion/total），与 backfill_log 对齐落盘。[file:1]

### S3.2 交付物（必须存在）

- `roi_debug.png`：每类 route_type 抽样 ≥50 张（原图+RoI 框+裁剪图）。[file:1]
- `efficiency_frontier.csv/png`：B ∈ {5,10,20,30}% 的 CER、boundary recall、p95 latency、mean tokens。[file:1]
- `call_rate_over_time.png`：窗口 call rate 随时间曲线（对比 fixed vs online）。[file:1]

### S3.3 硬验收阈值

- 每个 B 点仍必须达标 `B ± 0.5%`。[file:1]
- RoI 模式 p95 latency 相对 Full-image 升级显著下降（阈值可不写死，但必须报告）。[file:1]
- roi_debug 人工抽检通过率 > 95%（目标字符/边缘笔画在视野内）。[file:1]

---

## 附：建议脚本入口（团队协作必备）

- `extract_features.py`：生成 router_features.jsonl。[file:1]
- `run_streaming_router.py`：流式 A→Router→(async)B→ 回填，输出 backfill_log.jsonl。[file:1]
- `train_calibrator.py`：val 上训练 LogReg/GBDT，输出权重与配置。[file:1]
- `eval_metrics.py`：统一口径算 CER/boundary/subst/CVR/AER/call rate/latency。[file:1]
- `dump_cases.py`：导出典型错例与 roi_debug。[file:1]
